---
name: vulnerability-scan
description: >
  依存関係の脆弱性スキャンスキル。
  bandit（Pythonコード静的解析）、safety（依存関係脆弱性）、pip-audit（依存関係脆弱性）を実行。
  重大度・説明・修正方法を含むマークダウンレポートを生成。
---

# Vulnerability Scan Skill

依存関係の脆弱性スキャンを実行します。

## 使い方

ユーザーが「脆弱性スキャンして」「依存関係の脆弱性をチェックして」「banditを実行して」などと言った場合に実行します。

## 実行するツール

### 1. bandit（Pythonコード静的解析）

Pythonコードのセキュリティ問題を検出します。

**検出パターン**:
- ハードコードされたパスワード
- `exec()`、`eval()`の使用
- `pickle`の使用
- `yaml.load()`の使用（`yaml.safe_load()`推奨）
- SQLインジェクションの可能性
- XMLインジェクションの可能性

### 2. safety（依存関係脆弱性スキャン）

依存関係の既知の脆弱性を検出します。

**データベース**: PyUp.io の脆弱性データベース

### 3. pip-audit（依存関係脆弱性スキャン）

PyPIパッケージの脆弱性を検出します。

**データベース**: OSV（Open Source Vulnerabilities）

## 実行フロー

### 1. ツールのインストール確認

```bash
# bandit、safety、pip-audit がインストールされているか確認
pip list | grep bandit
pip list | grep safety
pip list | grep pip-audit

# インストールされていない場合はインストール
pip install bandit safety pip-audit
```

### 2. スキャン実行

#### bandit実行

```bash
bandit -r app/ -f json -o bandit-report.json
```

**出力例**:
```json
{
  "results": [
    {
      "code": "SECRET_KEY = 'hardcoded-secret'",
      "filename": "app/core/config.py",
      "issue_confidence": "HIGH",
      "issue_severity": "HIGH",
      "issue_text": "Possible hardcoded password: 'hardcoded-secret'",
      "line_number": 15,
      "test_id": "B105",
      "test_name": "hardcoded_password_string"
    }
  ]
}
```

#### safety実行

```bash
safety check --json > safety-report.json
```

**出力例**:
```json
[
  {
    "advisory": "Jinja2 before 2.11.3 allows XSS",
    "package": "jinja2",
    "installed_version": "2.10.0",
    "vulnerable_spec": "<2.11.3",
    "analyzed_version": "2.10.0"
  }
]
```

#### pip-audit実行

```bash
pip-audit --format=json > pip-audit-report.json
```

**出力例**:
```json
{
  "dependencies": [
    {
      "name": "requests",
      "version": "2.25.0",
      "vulns": [
        {
          "id": "PYSEC-2021-59",
          "description": "Requests before 2.26.0 allows CRLF injection",
          "fix_versions": ["2.26.0"]
        }
      ]
    }
  ]
}
```

### 3. レポート生成

マークダウンレポート（`vulnerability-scan-report.md`）を生成：

```markdown
# 脆弱性スキャンレポート

生成日時: 2024-01-20 10:30:00

## 📊 サマリー

- 🔴 高リスク: 2件
- 🟡 中リスク: 3件
- 🟢 低リスク: 1件
- ✅ 問題なし: 0件

---

## 🔴 高リスク（即修正）

### Hardcoded Password - app/core/config.py:15 (bandit)

**重大度**: HIGH
**信頼度**: HIGH

**問題**: ハードコードされたパスワード

**現在のコード**:
\`\`\`python
SECRET_KEY = 'hardcoded-secret'
\`\`\`

**修正案**:
\`\`\`python
# 環境変数で管理
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    SECRET_KEY: str = Field(..., env="SECRET_KEY")
\`\`\`

**参考**: [Bandit B105](https://bandit.readthedocs.io/en/latest/plugins/b105_hardcoded_password_string.html)

---

### Jinja2 XSS Vulnerability (safety)

**パッケージ**: jinja2
**インストール済みバージョン**: 2.10.0
**脆弱性**: CVE-2020-28493

**問題**: Jinja2 before 2.11.3 allows XSS

**修正方法**:
\`\`\`bash
pip install jinja2>=2.11.3
\`\`\`

**参考**: [CVE-2020-28493](https://nvd.nist.gov/vuln/detail/CVE-2020-28493)

---

## 🟡 中リスク（要確認）

### Requests CRLF Injection (pip-audit)

**パッケージ**: requests
**インストール済みバージョン**: 2.25.0
**脆弱性**: PYSEC-2021-59

**問題**: Requests before 2.26.0 allows CRLF injection

**修正方法**:
\`\`\`bash
pip install requests>=2.26.0
\`\`\`

**参考**: [PYSEC-2021-59](https://osv.dev/vulnerability/PYSEC-2021-59)

---

## 🟢 低リスク（推奨）

（該当なし）

---

## ✅ 問題なし

以下の項目は問題ありませんでした：

- SQLAlchemy: 最新版（脆弱性なし）
- FastAPI: 最新版（脆弱性なし）
- Pydantic: 最新版（脆弱性なし）

---

## 次のステップ

1. **高リスク項目を修正**: ハードコードされたシークレット、Jinja2脆弱性を最優先で修正
2. **中リスク項目を確認**: requests脆弱性を修正
3. **依存関係を更新**: `pip install -U <package>`で最新版に更新
4. **再スキャン**: 修正後に再度 `/vulnerability-scan` を実行

---

**生成者**: Claude Code `/vulnerability-scan` スキル
**日時**: 2024-01-20 10:30:00
```

### 4. レポート保存

`vulnerability-scan-report.md`として保存し、ユーザーに通知します。

## 実行後の対応

### 高リスク項目（🔴）

**即座に修正**が必要です。ハードコードされたシークレット、既知の脆弱性パッケージなどは、本番環境で重大な被害を引き起こす可能性があります。

### 中リスク項目（🟡）

**要確認**です。依存関係の脆弱性などは、バージョンアップで簡単に修正できます。

### 低リスク項目（🟢）

**推奨**です。最新版へのアップグレードなどが推奨されます。

## 次のステップ

レポート生成後、ユーザーに以下を提案してください：

- **高リスク項目を修正**: 最優先で修正
- **依存関係を更新**: `pip install -U <package>`で最新版に更新
- **再スキャン**: 修正後に再度 `/vulnerability-scan` を実行して問題が解消されたことを確認
- **CI/CDに統合**: GitHub Actionsで自動実行するように設定

## CI/CDへの統合

`.github/workflows/vulnerability-scan.yml`:
```yaml
name: Vulnerability Scan

on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install bandit safety pip-audit
      - name: Run bandit
        run: bandit -r app/ -f json -o bandit-report.json
        continue-on-error: true
      - name: Run safety
        run: safety check --json > safety-report.json
        continue-on-error: true
      - name: Run pip-audit
        run: pip-audit --format=json > pip-audit-report.json
        continue-on-error: true
      - name: Upload reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json
```

## ツールの詳細

### bandit

- **公式**: https://bandit.readthedocs.io/
- **目的**: Pythonコードの静的解析
- **検出**: ハードコードされたシークレット、危険な関数の使用等

### safety

- **公式**: https://pyup.io/safety/
- **目的**: 依存関係の脆弱性スキャン
- **データベース**: PyUp.io の脆弱性データベース

### pip-audit

- **公式**: https://github.com/pypa/pip-audit
- **目的**: 依存関係の脆弱性スキャン
- **データベース**: OSV（Open Source Vulnerabilities）
